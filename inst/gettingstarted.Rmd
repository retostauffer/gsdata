---
title: "`gsdata`: Getting Started"
author: "Reto Stauffer"
date: "`Sys.Date()`"
---


This small _R_ package allows to retrieve meteorological data
(weather data) from the GeoSphere data hub (Austrian national
weather service; formerly known as ZAMG).

The package was intended to be for personal use and is not rigorously
tested yet. Thus, if you find any bugs or improvements do not hesitate
to report them <https://github.com/retostauffer/gsdata/issues>. If I find
time, I'm happy to integrate them if needed.


## GeoSphere data hub

The [GeoSpere data hub](https://data.hub.geosphere.at/) provides access
to a series of different data sets. Some are publicly available, others
require login.

In its current state, the `gsdata` package only allows to download
station data from meteorological stations, and has no functionality
to deal with logins.

[This page](https://data.hub.geosphere.at/group/stationsdaten) lists
all available station datasets and provides links to the
[API documentation](https://dataset.api.hub.geosphere.at/v1/docs/) (which
now comes in English). There are a series of articles which might be
of interest for starters, e.g.:

* [Getting Started](https://dataset.api.hub.geosphere.at/v1/docs/getting-started.html)
* [Available Endpoints](https://dataset.api.hub.geosphere.at/v1/docs/user-guide/endpoints.html)
* [Licence](https://dataset.api.hub.geosphere.at/v1/docs/user-guide/license.html)
* [FastAPI documentation](https://dataset.api.hub.geosphere.at/v1/openapi-docs)
* ... and more.

## By-hand example {#byhand}

**Note:** This section describes how the package works under the hood and how the API works.
If you are solely interested on how to use the `gsdata` package directly, go to the next
section ([Using the `gsdata` package](#usinggsdata))

In this vignette we are interested in getting historical data with a 10-minute
resolution from a station in Tyrol (Airport Innsbruck) and go trough the different
end-points "by hand" for those interested. What we would like to have are three different
things:

* Find out how which datasets are available (via API)
* Access the metadata for the dataset of interest to see which stations are available
* Get some data for a specific station

**Datasets:** The endpoint <https://dataset.api.hub.geosphere.at/v1/datasets?type=station>
gives us a 'list' of existing endpoints (filtered for station data). One of the entries
(the one we are interested in) looks as follows:

```
"/station/historical/klima-v1-10min": {
    "type": "station",
    "mode": "historical",
    "response_formats": ["geojson", "csv"],
    "url": "https://dataset.api.hub.geosphere.at/v1/station/historical/klima-v1-10min"
}
```

This defines the endpoint for "`historical` `station` data for the dataset called
`klima-v1-10min`. Note: this endpoint provides historical `10min` data for TAWES stations
(automated weather stations; Teilautomatische Wetterstation), the endpoint
`historical/tawes-v1-10min` does not reach far back in time.

Although giving us the data we need, the station ids are _not_ the same as for
tawes data (e.g., when retrieving the latest observations via `current/tawes-v1-10min).
A bit inconvenient, but one should be able to get around it.
The `url` defines the API endpoint we need in the next step.


**Metadata:** By adding `/metadata` at the end of the `url` given above we can retrieve
information about all the available parameters (as well as their naming convention
and description) as well a list of stations which (should) provide data.

* <https://dataset.api.hub.geosphere.at/v1/station/historical/klima-v1-10min/metadata>

For this example: Let us assume we are interested in the amount of
precipitation measured (`RR` in millimeters per 10 minutes) as well as
the dry air temperature (`TL` in degrees Celsius) for the station with
the id `11804` (Innsbruck Airport, automated weather station). We will
need the name of the parameters (`RR`, `TL`) as well as the station id (`11804`)
for the data request in the next step.

```
"parameters": [
    ...
    {
        "name": "RR",
        "long_name": "Niederschlag der letzten 10 Minuten",
        "desc": "Niederschlag der letzten 10 Minuten",
        "unit": "mm"
    },
    ...
    {
        "name": "TL",
        "long_name": "Lufttemperatur",
        "desc": "Lufttemperatur 10 Minuten",
        "unit": "Â°C"
    },
    ...
],
...
"stations": [
    ...
    {
        "type": "INDIVIDUAL",
        "id": "11804",
        "group_id": null,
        "name": "INNSBRUCK-FLUGPLATZ",
        "state": "Tirol",
        "lat": 47.259998,
        "lon": 11.356667,
        "altitude": 578,
        "valid_from": "1992-11-24T00:00+00:00",
        "valid_to": "2100-12-31T00:00+00:00",
        "has_sunshine": true,
        "has_global_radiation": true,
        "is_active": true
    },
    ...
]

```

**Data:** With the information above, we can now retrieve data.
Note that the API allows to retrieve the data in different formats, for station
data this is currently `geojson` and `csv` (see 'Datasets' above).

To query the data we need to send a GET request to the API endpoint for our
data set and provide a few additional arguments such as `parameters`, `station_ids`
and the time period we are interested in. More examples can be found
on the [FastAPI documentation](https://dataset.api.hub.geosphere.at/v1/openapi-docs).
What we want to query in this example is the following:

```{r byhand_url}
url <- "https://dataset.api.hub.geosphere.at/v1/station/historical/klima-v1-10min?parameters=RR,TL&station_ids=11804&start=2020-01-01T00:00&end=2020-01-01T01:00"
```

* <`r url`>

... here requesting data for January 1, 2020, for one hour (0000 UTC to 0100 UTC). The
result (`format = "geojson"`) should look as follows:


```{r byhand_example, echo = FALSE, comment = ""}
require("httr")
require("jsonlite")
req <- httr::GET(url)
jsonlite::prettify(req)
```

## Using the `gsdata` package {#usinggsdata}

This _R_ package does nothing different than what is shown above in a user-friendly
way, but does not provide all features of the API. To give an overview of the features
let us replicate the steps shown in the [By-hand example section](#byhand).

**Loading the library:**

```{r loading_lib}
library("gsdata")
```

**Datasets:** `gs_datasets()` returns a list of all available datasets. By default,
only station data sets (default `type = "station"`). The return value is a `data.frame`
containing all the required information such das `type`, `mode`, `resource_id` as well
as the `url` of the endpoint.

```{r gs_datasets}
ds <- gs_datasets()
ds
```

**Metainfo:** `gs_metadata()` allows to query the meta information for a specific data set.
To get this information, `mode`, `resource_id` as well as `type` need to be specified. This
information is found in the `data.frame` returned by `gs_datasets()`. In this example we
are once again interested in the meta information for the `klima-v1-10min` data set.

```{r gs_metadata}
meta <- gs_metadata(mode = "historical", resource_id = "klima-v1-10min", type = "station")
names(meta)
```

The return is a named list with a series of information extracted from the metadata endpoint.
Two entries of most importance are `$parameters` (class `data.frame`) with the information about the vailable parameters for
this data set as well as `$stations` with a list of stations (class `c("sf", "data.frame")`).

```{r gs_metadata_parameters}
dim(meta$parameters)
subset(meta$parameters, name %in% c("RR", "TL")) # The ones used in this vignette
```

```{r gs_metadata_stations}
dim(meta$stations)
(IBK <- subset(meta$stations, name == "INNSBRUCK-FLUGPLATZ"))
IBK$id # The station_id needed for the next step
```

As `$stations` is a simple feature object, we can also plot the data if needed.

```{r gs_metdata_plot, fig = TRUE, fig.width = 8, fig.height = 5, out.width = "100%"}
library("sf")
library("ggplot2")
library("rnaturalearth")
ne <- ne_countries("medium", returnclass = "sf")

ggplot() +
    geom_sf(data = ne) +
    geom_sf(aes(col = state), data = meta$stations) +
    coord_sf(xlim = st_bbox(meta$stations)[c(1, 3)],
             ylim = st_bbox(meta$stations)[c(2, 4)])
```


**Data:** To get the data themselves, the steps above are not required once
`type`, `mode`, `resource_id`, `parameters` as well as `station_id`s are known.
`gs_stationdata()` can be used to retrieve data for one or multiple stations
and parameters all at once and also takes care to not send requests to the
API exceeding the [APIs request size limit](https://dataset.api.hub.geosphere.at/v1/docs/user-guide/request_size_limit.html).

The return is a `c("gs_stationdata", "zoo")`time series object (if only one
station is requested) or a named list with time series objects (one per
station if `length(request_id) > 1`).

```{r gs_stationdata}
data <- gs_stationdata(mode        = "historical",
                       resource_id = "klima-v1-10min",
                       parameters  = c("RR", "TL"),
                       start       = "2020-01-01",
                       end         = "2020-03-01",
                       station_ids = 11804,
                       expert      = TRUE)

class(data)
head(data)
```

```{r gs_stationdata_plot, fig = TRUE, out.width = "100%", fig.width = 10, fig.height = 5}
plot(data, col = c("steelblue", 2))
```











